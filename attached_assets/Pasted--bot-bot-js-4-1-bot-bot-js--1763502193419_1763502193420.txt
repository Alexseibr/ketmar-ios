ÐÐ°ÑÑ‚Ñ€Ð°Ð¸Ð²Ð°ÐµÐ¼ Ð±Ð¾Ñ‚Ð° (Ñ„Ð°Ð¹Ð» bot/bot.js)

Ð¢ÐµÐ¿ÐµÑ€ÑŒ Ð±Ð¾Ñ‚.

4.1. ÐžÑ‚ÐºÑ€Ð¾Ð¹ bot/bot.js

Ð’ Ð»ÐµÐ²Ð¾Ð¹ Ð¿Ð°Ð½ÐµÐ»Ð¸ Ð½Ð°Ð¹Ð´Ð¸ Ð¿Ð°Ð¿ÐºÑƒ bot.

Ð’Ð½ÑƒÑ‚Ñ€Ð¸ â€” Ñ„Ð°Ð¹Ð» bot.js.

ÐžÑ‚ÐºÑ€Ð¾Ð¹ ÐµÐ³Ð¾ Ð¸ Ð¿Ð¾Ð»Ð½Ð¾ÑÑ‚ÑŒÑŽ Ð·Ð°Ð¼ÐµÐ½Ð¸ ÑÐ¾Ð´ÐµÑ€Ð¶Ð¸Ð¼Ð¾Ðµ Ð½Ð° ÑÑ‚Ð¾Ñ‚ ÐºÐ¾Ð´:

// bot/bot.js
const { Telegraf } = require("telegraf");
const axios = require("axios");

function startBot() {
  const token = process.env.BOT_TOKEN;
  if (!token) {
    console.error("âŒ BOT_TOKEN Ð½Ðµ ÑƒÐºÐ°Ð·Ð°Ð½ Ð² Ð¿ÐµÑ€ÐµÐ¼ÐµÐ½Ð½Ñ‹Ñ… Ð¾ÐºÑ€ÑƒÐ¶ÐµÐ½Ð¸Ñ");
    return;
  }

  const API_BASE_URL = process.env.API_BASE_URL || "http://localhost:3000";

  const bot = new Telegraf(token);

  // /start
  bot.start((ctx) => {
    ctx.reply(
      "ÐŸÑ€Ð¸Ð²ÐµÑ‚! Ð­Ñ‚Ð¾ KETMAR Market.\n\n" +
      "ÐšÐ¾Ð¼Ð°Ð½Ð´Ñ‹:\n" +
      "/myid â€” Ð¿Ð¾ÐºÐ°Ð·Ð°Ñ‚ÑŒ Ð´Ð°Ð½Ð½Ñ‹Ðµ Ñ‚Ð²Ð¾ÐµÐ³Ð¾ Telegram-Ð°ÐºÐºÐ°ÑƒÐ½Ñ‚Ð°\n" +
      "/categories â€” Ð¿Ð¾ÐºÐ°Ð·Ð°Ñ‚ÑŒ Ð´ÐµÑ€ÐµÐ²Ð¾ ÐºÐ°Ñ‚ÐµÐ³Ð¾Ñ€Ð¸Ð¹\n" +
      "/new_test_ad â€” ÑÐ¾Ð·Ð´Ð°Ñ‚ÑŒ Ñ‚ÐµÑÑ‚Ð¾Ð²Ð¾Ðµ Ð¾Ð±ÑŠÑÐ²Ð»ÐµÐ½Ð¸Ðµ 'Ð¡Ð²ÐµÐ¶Ð°Ñ Ð¼Ð°Ð»Ð¸Ð½Ð°'"
    );
  });

  // /myid
  bot.command("myid", (ctx) => {
    const u = ctx.from;
    ctx.reply(
      `Ð¢Ð²Ð¾Ð¹ Telegram ID: ${u.id}\n` +
      `Ð˜Ð¼Ñ: ${u.first_name || ""} ${u.last_name || ""}\n` +
      `Username: @${u.username || "Ð½ÐµÑ‚"}`
    );
  });

  // /categories
  bot.command("categories", async (ctx) => {
    try {
      const url = `${API_BASE_URL}/api/categories`;
      const res = await axios.get(url);
      const tree = res.data;

      if (!tree || tree.length === 0) {
        return ctx.reply("ÐšÐ°Ñ‚ÐµÐ³Ð¾Ñ€Ð¸Ð¹ Ð¿Ð¾ÐºÐ° Ð½ÐµÑ‚. Ð’Ð¾Ð·Ð¼Ð¾Ð¶Ð½Ð¾, Ð½Ðµ Ð·Ð°Ð¿ÑƒÑ‰ÐµÐ½ ÑÐ¸Ð´ÐµÑ€ (npm run seed).");
      }

      let text = "ðŸ“‚ ÐšÐ°Ñ‚ÐµÐ³Ð¾Ñ€Ð¸Ð¸:\n\n";
      for (const cat of tree) {
        text += `â€¢ ${cat.name} (slug: ${cat.slug})\n`;
        if (cat.subcategories && cat.subcategories.length) {
          for (const sub of cat.subcategories) {
            text += `   â””â”€ ${sub.name} (slug: ${sub.slug})\n`;
          }
        }
        text += "\n";
      }

      ctx.reply(text);
    } catch (err) {
      console.error("/categories error:", err.message);
      ctx.reply("ÐžÑˆÐ¸Ð±ÐºÐ° Ð¿Ñ€Ð¸ Ð·Ð°Ð¿Ñ€Ð¾ÑÐµ ÐºÐ°Ñ‚ÐµÐ³Ð¾Ñ€Ð¸Ð¹. ÐŸÑ€Ð¾Ð²ÐµÑ€ÑŒ, Ñ‡Ñ‚Ð¾ API Ð·Ð°Ð¿ÑƒÑ‰ÐµÐ½ Ð¸ Ð´Ð¾ÑÑ‚ÑƒÐ¿ÐµÐ½.");
    }
  });

  // /new_test_ad â€” Ñ‚ÐµÑÑ‚Ð¾Ð²Ð¾Ðµ Ð¾Ð±ÑŠÑÐ²Ð»ÐµÐ½Ð¸Ðµ
  bot.command("new_test_ad", async (ctx) => {
    try {
      const user = ctx.from;

      const payload = {
        title: "Ð¡Ð²ÐµÐ¶Ð°Ñ Ð¼Ð°Ð»Ð¸Ð½Ð° (Ñ‚ÐµÑÑ‚Ð¾Ð²Ð¾Ðµ Ð¾Ð±ÑŠÑÐ²Ð»ÐµÐ½Ð¸Ðµ)",
        description: "Ð”Ð¾Ð¼Ð°ÑˆÐ½ÑÑ Ð¼Ð°Ð»Ð¸Ð½Ð°, Ð±ÐµÐ· Ñ…Ð¸Ð¼Ð¸Ð¸. Ð¡Ð¾Ð·Ð´Ð°Ð½Ð¾ Ñ‡ÐµÑ€ÐµÐ· ÐºÐ¾Ð¼Ð°Ð½Ð´Ñƒ /new_test_ad.",
        categoryId: "farm",
        subcategoryId: "berries",
        price: 10,
        currency: "BYN",
        attributes: {
          berryType: "Ð¼Ð°Ð»Ð¸Ð½Ð°",
          isOrganic: true,
        },
        photos: [],
        sellerTelegramId: user.id,
        deliveryType: "delivery_and_pickup",
        deliveryRadiusKm: 5,
        location: null,
        seasonCode: null,
        lifetimeDays: 7,
      };

      const res = await axios.post(`${API_BASE_URL}/api/ads`, payload);
      const ad = res.data;

      ctx.reply(
        "âœ… Ð¢ÐµÑÑ‚Ð¾Ð²Ð¾Ðµ Ð¾Ð±ÑŠÑÐ²Ð»ÐµÐ½Ð¸Ðµ ÑÐ¾Ð·Ð´Ð°Ð½Ð¾.\n\n" +
        `ID: ${ad._id}\n` +
        `Ð—Ð°Ð³Ð¾Ð»Ð¾Ð²Ð¾Ðº: ${ad.title}\n` +
        `Ð¦ÐµÐ½Ð°: ${ad.price} ${ad.currency}`
      );
    } catch (err) {
      console.error("/new_test_ad error:", err.response?.data || err.message);
      ctx.reply("ÐžÑˆÐ¸Ð±ÐºÐ° Ð¿Ñ€Ð¸ ÑÐ¾Ð·Ð´Ð°Ð½Ð¸Ð¸ Ñ‚ÐµÑÑ‚Ð¾Ð²Ð¾Ð³Ð¾ Ð¾Ð±ÑŠÑÐ²Ð»ÐµÐ½Ð¸Ñ. Ð¡Ð¼. Ð»Ð¾Ð³Ð¸ ÑÐµÑ€Ð²ÐµÑ€Ð°.");
    }
  });

  // Ð¿Ñ€Ð¾ÑÑ‚Ð°Ñ Ñ€ÐµÐ°ÐºÑ†Ð¸Ñ Ð½Ð° "Ð¿Ñ€Ð¸Ð²ÐµÑ‚"
  bot.hears(/Ð¿Ñ€Ð¸Ð²ÐµÑ‚/i, (ctx) => ctx.reply("ÐŸÑ€Ð¸Ð²ÐµÑ‚! Ð˜ÑÐ¿Ð¾Ð»ÑŒÐ·ÑƒÐ¹ /start, Ñ‡Ñ‚Ð¾Ð±Ñ‹ ÑƒÐ²Ð¸Ð´ÐµÑ‚ÑŒ ÐºÐ¾Ð¼Ð°Ð½Ð´Ñ‹."));

  bot.launch()
    .then(() => console.log("ðŸ¤– Telegram Bot started (long polling)"))
    .catch((err) => console.error("Bot launch error:", err));

  return bot;
}

module.exports = startBot;


Ð¡Ð¾Ñ…Ñ€Ð°Ð½Ð¸ Ñ„Ð°Ð¹Ð».